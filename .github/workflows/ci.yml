name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  NODE_OPTIONS: '--max-old-space-size=4096'
  # Build-time environment variables
  DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy
  AUTH_SECRET: ${{ secrets.AUTH_SECRET || 'dummy-secret-for-build' }}
  RESEND_API_KEY: ${{ secrets.RESEND_API_KEY || 'dummy-resend-key' }}

jobs:
  # ðŸš€ Complete CI Pipeline
  ci-pipeline:
    name: ðŸš€ CI Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Run CI Pipeline
        uses: ./.github/actions/ci-pipeline
        with:
          run-build: true
          run-security: true
          fail-on-high: true
          fail-on-critical: true
          upload-artifacts: true

  # ðŸ“Š Summary and Reporting
  summary:
    name: ðŸ“Š CI Summary
    runs-on: ubuntu-latest
    needs: ci-pipeline
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.ci-pipeline.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Audit | ${{ needs.ci-pipeline.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.ci-pipeline.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.ci-pipeline.result }}" != "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ CI Pipeline failed - check logs for details" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All CI checks passed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Ready for deployment!" >> $GITHUB_STEP_SUMMARY
